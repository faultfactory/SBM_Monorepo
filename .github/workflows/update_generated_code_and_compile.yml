# This is a basic workflow to help you get started with Actions

name: update_autogenerated_can_and_compile

# Controls when the workflow will run
  # Triggers the workflow or pull request events but only for the "main" branch
on: 
  push:
  pull_request:
    types: [opened]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
 conditional_job_check_dbc:
    runs-on: 'ubuntu-latest'
    # Declare outputs for next jobs
    outputs:
      dbc_changed: ${{ steps.check_file_changed.outputs.dbc_changed }}
    steps:
    - uses: actions/checkout@v3
      with:
        # Checkout as many commits as needed for the diff
        fetch-depth: 0 # this gets all commits
    - shell: pwsh
      id: check_file_changed
      run: |
        # Diff HEAD with the last commit pushed
        $diff = git diff --name-only ${{github.event.before}} ${{github.event.after}}

        # Check if a file under dbc/ or with the .dbc extension has changed (added, modified, deleted)
        $SourceDiff = $diff | Where-Object { $_ -match '^dbc/' -or $_ -match '.dbc$' }
        $HasDiff = $SourceDiff.Length -gt 0

        # Set the output named "dbc_changed"
        Write-Host "::set-output name=dbc_changed::$HasDiff"
 generate_c_interface:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: [ conditional_job_check_dbc ]
    if: needs.conditional_job_check_dbc.outputs.dbc_changed == 'True'
    # Steps represent a sequence of tasks that will be executed as part of the job
    outputs:
      auto_commit_sha: ${{ steps.pass.outputs.auto_commit_sha }}
    steps:
      - uses: actions/checkout@v3
      - uses: vweevers/multi-checkout-action@v1
        with:
          repositories: howerj/dbcc
      - name: build_dbcc
        run: | 
          cd $GITHUB_WORKSPACE/../howerj/dbcc
          make
      - name: Generate .h and .c files from dbc
        run: |
          mkdir -p $GITHUB_WORKSPACE/can_conv
          cd $GITHUB_WORKSPACE/../howerj/dbcc
          ./dbcc -v -o $GITHUB_WORKSPACE/can_conv $GITHUB_WORKSPACE/dbc/*.dbc 
      - name: Git commit / Push Changes
        uses: actions-x/commit@v6
        with:
          message: "Automated CAN interface file update"
          files: can_conv/*
      - name: pass_new_commit_sha
        id: pass
        run: |
          echo ::set-output name=auto_commit_sha::$(git rev-parse HEAD)
          echo $(git rev-parse HEAD)
 compile_all_sketches:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [conditional_job_check_dbc, generate_c_interface]
    steps:
      - uses: actions/checkout@v3
      - name: conditional checkout
      # if the dbc file as marked as changed, we have since made a new commit, check out the files and merge. 
        if: needs.conditional_job_check_dbc.outputs.dbc_changed == 'True'
        uses: actions/checkout@v3
        with: 
          ref: ${{ needs.generate_c_interface.outputs.auto_commit_sha }}
      - name: Path lister action
        uses: Rishabh510/Path-lister-action@1.0
        id: pl
        with:
          path: .
          type: '.ino'
      - name: Report Number of found sketches
        run: |
          echo "Found ${{ steps.pl.outputs.path_count }} file(s) identified as Arduino Sketches:"
          for i in ${{ steps.pl.outputs.paths }}; do
          echo $i
          done
      - name: Read yaml
        id: library_data
        uses: KJ002/read-yaml@1.6
        with:
          file: ./required_arduino_libraries.yml
          key-path: '["libraries"]'
      - name: Compile Arduino Sketches
        uses: arduino/compile-sketches@v1
        with:
          fqbn: 'adafruit:samd:adafruit_feather_m4_can'
          platforms:  |
            - name: "adafruit:samd"
              source-url: "https://adafruit.github.io/arduino-board-index/package_adafruit_index.json"
          libraries: ${{ steps.library_data.outputs.data }}
          sketch-paths: ${{ steps.pl.outputs.paths }}
